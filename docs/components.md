# Компоненты RAG-системы

В этом разделе подробно описаны основные компоненты RAG-системы, их функциональность и взаимодействие друг с другом.

## Основные компоненты

### 1. RAGService

`app/rag.py`

Центральный компонент системы, отвечающий за координацию всех процессов, связанных с RAG. Предоставляет высокоуровневый интерфейс для работы с документами, поиском и генерацией.

**Ключевые функции:**
- Обработка и индексация документов
- Поиск релевантной информации
- Формирование промптов для LLM
- Управление поисковым индексом

**Параметры конфигурации:**
- `model_name` - модель для создания эмбеддингов
- `collection_name` - название коллекции в Qdrant
- `dense_weight` - вес векторного поиска в гибридном
- `sparse_weight` - вес BM25 поиска в гибридном
- `reranker_weight` - вес переранжирования
- `chunking_mode` - режим разбиения документов

### 2. Vectorizer

`app/rag.py`

Компонент для создания векторных представлений (эмбеддингов) текстовых фрагментов и запросов.

**Ключевые функции:**
- Преобразование текста в векторы фиксированной размерности
- Поддержка моделей E5 (с использованием префиксов "passage:" и "query:")
- Обработка ошибок при загрузке моделей

### 3. UnifiedChunker

`app/chunking/unified_chunker.py`

Унифицированный компонент для разбиения документов на фрагменты с поддержкой различных стратегий.

**Ключевые функции:**
- Разбиение документов на фрагменты оптимального размера
- Поддержка различных методов чанкинга (символьный, токеновый, семантический)
- Автоматическое определение типа контента

**Режимы работы:**
- `character` - разбиение по символам с учетом разделителей
- `token` - разбиение по токенам моделей
- `semantic` - семантическое разбиение с учетом структуры предложений и абзацев

### 4. HierarchicalChunker

`app/chunking/hierarchical_chunker.py`

Специализированный компонент для разбиения документов с учетом их иерархической структуры.

**Ключевые функции:**
- Обнаружение и использование заголовков для структурирования фрагментов
- Сохранение контекста от родительских заголовков
- Адаптивное определение размера фрагментов

### 5. QdrantIndex

`app/rag.py`

Компонент для работы с векторной базой данных Qdrant, используемой для хранения и поиска векторных представлений.

**Ключевые функции:**
- Создание и управление коллекциями
- Добавление и обновление векторов и метаданных
- Векторный поиск с использованием косинусного сходства
- Управление метаданными фрагментов

### 6. HybridRetriever

`app/retrieval/hybrid_retriever.py`

Компонент для комбинированного поиска, объединяющий результаты векторного и лексического поиска.

**Ключевые функции:**
- Создание и обслуживание индекса BM25
- Комбинирование результатов разных методов поиска
- Переранжирование с использованием cross-encoder
- Адаптивное определение количества возвращаемых результатов

### 7. OllamaClient

`app/ollama_client.py`

Клиент для работы с Ollama API, обеспечивающий доступ к локальным языковым моделям.

**Ключевые функции:**
- Загрузка и использование локальных LLM
- Настройка параметров генерации
- Обработка ошибок и повторные попытки при сбоях
- Потоковая генерация ответов

## Структура данных

### Document

Представляет исходный документ для обработки и индексации.

**Атрибуты:**
- `content` - текстовое содержимое документа
- `metadata` - метаданные документа (источник, заголовок и т.д.)

### Chunk

Представляет фрагмент документа после разбиения.

**Атрибуты:**
- `text` - текстовое содержимое фрагмента
- `doc_id` - идентификатор исходного документа
- `chunk_id` - номер фрагмента в документе
- `metadata` - метаданные фрагмента (заголовок, источник и т.д.)

## API и интерфейсы

### FastAPI Роутеры

`app/routers/*.py`

Компоненты, отвечающие за обработку HTTP-запросов и маршрутизацию.

#### DocumentRouter

Обрабатывает запросы, связанные с управлением документами:
- Загрузка документов
- Получение списка документов
- Удаление документов
- Переиндексация документов

#### ChatRouter

Обрабатывает запросы, связанные с генерацией ответов:
- Генерация ответов с использованием RAG
- Прямые запросы к языковой модели
- Получение и очистка истории запросов

#### UserRouter

Обрабатывает запросы, связанные с пользователями:
- Регистрация и аутентификация
- Управление пользовательскими настройками
- Управление ролями и правами доступа

## Модели данных и схемы

### SQLAlchemy Models

`app/models.py`

ORM-модели для работы с базой данных:
- `User` - информация о пользователях
- `Document` - метаданные документов
- `Chat` - история запросов и ответов
- `ModelSettings` - настройки модели для пользователей

### Pydantic Schemas

`app/schemas.py`

Схемы данных для валидации и сериализации:
- `UserCreate`, `UserInDB`, `UserOut` - работа с пользователями
- `DocumentCreate`, `DocumentOut` - работа с документами
- `ChatCreate`, `ChatOut` - работа с запросами и ответами
- `ModelSettingsCreate`, `ModelSettingsOut` - работа с настройками моделей

## Утилиты и вспомогательные компоненты

### Config

`app/config.py`

Компонент для работы с конфигурацией приложения:
- Загрузка настроек из файла .env
- Настройки подключения к базам данных
- Параметры RAG и эмбеддингов
- Настройки безопасности

### Database

`app/database.py`

Компонент для работы с базой данных:
- Создание и управление соединением
- Создание и обновление схемы базы данных
- Миграции и обновления

### Logging

`app/logging_config.py`

Компонент для настройки и управления логированием:
- Настройка форматов и уровней логирования
- Ротация логов
- Отдельные логгеры для разных компонентов системы 