#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ Ollama
if ! curl -s http://localhost:11434/api/tags > /dev/null; then
  echo "‚ùå Ollama –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å Ollama –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º."
  echo "   –ù–∞ macOS –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: open -a Ollama"
  echo "   –ù–∞ Linux –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: ollama serve"
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–æ–¥–µ–ª–∏ mistral:7b-instruct
if ! curl -s http://localhost:11434/api/tags | grep -q "mistral:7b-instruct"; then
  echo "‚ö†Ô∏è –ú–æ–¥–µ–ª—å mistral:7b-instruct –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Ollama. –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É..."
  echo "üì• –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ mistral:7b-instruct –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è (~4-5 –ì–ë)."
  curl -X POST http://localhost:11434/api/pull -d '{"name": "mistral:7b-instruct"}'
  echo "‚úÖ –ú–æ–¥–µ–ª—å mistral:7b-instruct —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞."
fi

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f .env ]; then
  echo "üìÑ –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ .env –∏–∑ –ø—Ä–∏–º–µ—Ä–∞..."
  cp .env.example .env
  echo "‚úÖ –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω."
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ db-init
if [ ! -d "db-init" ]; then
  echo "üìÇ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
  mkdir -p db-init
  echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è db-init —Å–æ–∑–¥–∞–Ω–∞."
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π
if [ -d "migrations" ]; then
  echo "üîÑ –ù–∞–π–¥–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π. –í –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ."
  echo "üìù –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤, –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –±—É–¥–µ—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞."
  mv migrations migrations.backup.$(date +%Y%m%d%H%M%S)
  echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏."
fi

# –ó–∞–ø—É—Å–∫ docker-compose
echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker-compose up -d --build

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 10

echo "
‚úÖ –°–∏—Å—Ç–µ–º–∞ RAG –∑–∞–ø—É—â–µ–Ω–∞!

üìö –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:
   * –§—Ä–æ–Ω—Ç–µ–Ω–¥: http://localhost:3000
   * API –±—ç–∫–µ–Ω–¥–∞: http://localhost:8000
   * Qdrant UI: http://localhost:6333/dashboard

üîç –õ–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞: docker-compose logs -f backend
üñ•Ô∏è –õ–æ–≥–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞: docker-compose logs -f frontend

‚ùì –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
   * –õ–æ–≥–∏–Ω: admin
   * Email: admin@example.com
   * –ü–∞—Ä–æ–ª—å: admin123

üìã –ö–∞–∫ –Ω–∞—á–∞—Ç—å:
   1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000 –≤ –±—Ä–∞—É–∑–µ—Ä–µ
   2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, –∏—Å–ø–æ–ª—å–∑—É—è –¥–µ–º–æ-—É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
   4. –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –≤ —á–∞—Ç–µ
" 